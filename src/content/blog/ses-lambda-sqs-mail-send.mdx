---
title: SESÃ—LambdaÃ—SQSã§ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹
slug: ses-lambda-sqs-mail-send
createdAt: Jul 05, 2025
tags:
  - AWS
  - Cloudflare
summary: æœ¬ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®å•ã„åˆã‚ã›ãƒšãƒ¼ã‚¸ã§ä½¿ç”¨ã—ã¦ã„ã‚‹ã€SESã¨Lambdaã€SQSã‚’çµ„ã¿åˆã‚ã›ãŸãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ä»•çµ„ã¿ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
theme: gray
---
import { Image } from 'astro:assets';
import image0 from '../../assets/blog/sqs-lambda-trigger.png';
import image1 from '../../assets/blog/lambda-sqs-log.png';
import image3 from '../../assets/blog/sqs-lambda-ses-arch.png';

# æ¦‚è¦

å•ã„åˆã‚ã›ãŒæ¥ãŸæ™‚ã«ã€ã©ã®ã‚ˆã†ã«é€šçŸ¥ã™ã‚‹ã‹ã¯ã„ãã¤ã‹é¸æŠè‚¢ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ä¾‹ãˆã°ã€Google Spreadsheetã«æ›¸ãè¾¼ã‚€ã€Slackã«é€šçŸ¥ã™ã‚‹ã€ãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹ãªã©ã§ã™ã€‚

æœ¬ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã§ã¯ã€ã‚¤ãƒ³ãƒ•ãƒ©ã®ç·´ç¿’ã‚‚å…¼ã­ã¦ãƒ¡ãƒ¼ãƒ«ã‚’ç”¨ã„ã¦è¡Œã†ã“ã¨ã«ã—ã¾ã—ãŸã€‚

# æ§‹æˆ

<Image src={image3} alt="SES Lambda SQSã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£"/>

æ§‹æˆã¯ã€Cloudflare Workersã®SSRã‹ã‚‰Amazon SQSã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ã’ã¦ã€AWS Lambdaã§ãã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚Šã€AWS SESã‚’ç”¨ã„ã¦ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚
ã“ã®æ§‹æˆã‚’æ¡ç”¨ã—ãŸç†ç”±ã¯ã€ä¸»ã«ä»¥ä¸‹ã®3ã¤ã§ã™ã€‚

- æ±ç”¨çš„ã«ä½¿ãˆã‚‹ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ä»•çµ„ã¿ã‚’ä½œã‚‹ãŸã‚
- éåŒæœŸã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†ã‚’è¡Œã†ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¾…ã¡æ™‚é–“ã‚’æ¸›ã‚‰ã™ãŸã‚
- Amazon SQS Ã— Amazon Lambdaã®å®šç•ªã®çµ„ã¿åˆã‚ã›ã«è§¦ã‚Œã‚‹ãŸã‚

ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«ã¤ã„ã¦ã¯ã€ã‚ˆãã‚ã‚‹Resendã‚„SendGridç­‰ã‚’ä½¿ã£ã¦ã‚‚è‰¯ã„ã®ã§ã™ãŒã€AWSå¤§å¥½ããƒãƒ³ãªã®ã§ã€SESã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã—ãŸã€‚

ã¾ãŸã€AWSã®é‰„æ¿ã‚µãƒ¼ãƒ“ã‚¹ã¨ã„ãˆã°ã€S3ã€EC2ã€SQSã§ã™ãŒã€å”¯ä¸€SQSã ã‘å…¨ãè§¦ã‚ŒãŸã“ã¨ãŒãªã‹ã£ãŸã®ã§ã“ã®æ©Ÿä¼šã«è§¦ã‚Œã¦ã¿ã¾ã—ãŸã€‚
SQSã¯å¯ç”¨æ€§ãŒé«˜ãã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã§ã€Lambdaã¨ã®çµ„ã¿åˆã‚ã›ã¯éå¸¸ã«ä¸€èˆ¬çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

ä»¥ä¸‹ã®è³‡æ–™ãŒã¨ã¦ã‚‚ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚

https://speakerdeck.com/pikosan0000/sqs-lambda-devday2022

# 1. SQSã®ä½œæˆ

ã¾ãšã€SQSã‚’ä½œæˆã—ã¾ã™ã€‚

ä»Šå›ã¯ç‰¹ã«ä½•ã‚‚è€ƒãˆãšã«ãƒãƒã‚³ãƒ³ã‹ã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã§ä½œæˆã—ã¾ã—ãŸã€‚

# 2. Lambdaã®ä½œæˆ

æ¬¡ã«ã€Lambdaã‚’ä½œæˆã—ã¾ã™ã€‚

è¨€èªã¯ç‰¹ã«ã“ã ã‚ã‚ŠãŒãªã‹ã£ãŸã®ã§ã€Golangã§æ›¸ãã¾ã—ãŸã€‚
ã¾ãšã¯SQSã¨ã®ç–é€šã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€ã‚·ãƒ³ãƒ—ãƒ«ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚

ã¡ã‚‡ã£ã¨ã”ã¡ã‚ƒã¤ã„ã¦ã¾ã™ãŒã€eventã‚’å—ã‘å–ã£ã¦ãã®å†…å®¹ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã™ã‚‹ã ã‘ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

```go
package main

import (
	"context"
	"log"

	"github.com/aws/aws-lambda-go/lambda"
)

type SendHandler struct{}

func NewSendHandler() *SendHandler {
	return &SendHandler{}
}

func (sh *SendHandler) HandleRequest(ctx context.Context, event map[string]interface{}) error {
	log.Println("start handling event.", event)
	return nil
}

func main() {
	handler := NewSendHandler()
	lambda.Start(handler.HandleRequest)
}
```

æ¬¡ã«ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã„ã¾ã™ã€‚

ã“ã‚Œã¯ã‚‚ã†æ…£ã‚ŒãŸã‚‚ã®ã§ã™ã€‚ã“ã¡ã‚‰ã®Dockerfileã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰ã—ã¦ECRã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚

```dockerfile
FROM golang:1.24 AS build

WORKDIR /app

COPY ./go.mod ./go.sum ./
RUN go mod download

COPY . .

ENV GOOS=linux
ENV GOARCH=amd64

RUN go build -tags lambda.norpc -o main ./main.go

FROM public.ecr.aws/lambda/provided:al2023

COPY --from=build /app/main ./main
ENTRYPOINT [ "./main" ]
```

# 3. SQS -> Lambdaã¸ã®ãƒˆãƒªã‚¬ãƒ¼è¨­å®š

ã“ã“ã‹ã‚‰ã¯AWSã®ãƒãƒã‚³ãƒ³ä¸Šã§ä½œæ¥­ã‚’è¡Œã„ã¾ã™ã€‚

ã¾ãšã€Lambdaã®ãƒˆãƒªã‚¬ãƒ¼ã‚’SQSã«è¨­å®šã—ã¾ã™ã€‚ã“ã‚Œã¯ã€è¨­å®š > ãƒˆãƒªã‚¬ãƒ¼ã§è¨­å®šã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚å…ˆã»ã©ä½œæˆã—ã¦SQSã‚’é¸æŠã™ã‚Œã°è‰¯ã„ã§ã™ã€‚

<Image src={image0} alt="SQSãƒˆãƒªã‚¬ãƒ¼ã®è¨­å®šç”»é¢" />

ã“ã“ã§SQSã«è¡Œãå‰ã«ã€IAMãƒ­ãƒ¼ãƒ«ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

å¿…è¦ãªæ¨©é™ã¯ä»¥ä¸‹ã§ã™ã€‚ä¾¿åˆ©ãªã“ã¨ã«ã€ãã‚Œã£ã½ã„ãƒ­ãƒ¼ãƒ«ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¿…è¦ãªæ¨©é™ã‚‚è¿½åŠ ã—ã¦ãŠãã¾ã™(FullAccessã§ã¯ãªãã€å¿…è¦ãªæ¨©é™ã ã‘ã‚’ä»˜ä¸ã™ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã§ã™ãŒã€ä»Šå›ã¯ç°¡å˜ã«ã™ã‚‹ãŸã‚ã«FullAccessã‚’ä»˜ä¸ã—ã¦ã„ã¾ã™)ã€‚

- AWSLambdaBasicExecutionRole
- AWSLambdaSQSQueueExecutionRole
- AmazonSESFullAccess

ãã‚Œã§ã¯ã€SQSã‹ã‚‰Lambdaã¸ã®ç–é€šã‚’ç¢ºèªã—ã«è¡Œãã¾ã™ã€‚

ãƒãƒã‚³ãƒ³ã§ã¯ã€æ‰‹å‹•ã§SQSã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã“ã‹ã‚‰é©å½“ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ã¿ã¾ã™ã€‚

```json
{
  "message": "Hello world from SQS"
}
```

ç„¡äº‹ã€SQSã«å…¥ã£ãŸãƒ¡ãƒ¼ã‚»ãƒ¼ã‚¸ã‚’LambdaãŒå—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸğŸ™Œ

<Image src={image1} alt="Lambdaã®ãƒ­ã‚°ç”»é¢" />

# 4. SESã®è¨­å®š

ã“ã“ã§ã¯æ·±ãSESã®è¨­å®šã«ã¯è§¦ã‚Œã¾ã›ã‚“ã€‚

å…·ä½“çš„ã«ã¯ã€Cloudflareã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’SESã«ç™»éŒ²ã—ã¦ã€å¿…è¦ãªãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’Cloudflareã®DNSã«ç™»éŒ²ã—ã«è¡Œãã¾ã™ã€‚

ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚

https://qiita.com/SawaShuya/items/770ccc0cfeb5c1e427e4

# 5. Lambdaã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†ã®å®Ÿè£…

ä»¥ä¸‹ã¯ã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’è¡Œã†éƒ¨åˆ†ã«ãªã‚Šã¾ã™ã€‚

ã‚‚ã—ã‹ã—ãŸã‚‰ã€å°†æ¥çš„ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ä»•çµ„ã¿ã‚’ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ç½®ãæ›ãˆã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã®ã§ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¦å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

å®Ÿè£…è‡ªä½“ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã€ç”¨æ„ã•ã‚Œã¦ã„ã‚‹SESã®APIã‚’ç”¨ã„ã¦ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’è¡Œã†ã ã‘ã§ã™ã€‚

```go
package pkg

import (
	"context"

	"github.com/aws/aws-sdk-go-v2/config"
	"github.com/aws/aws-sdk-go-v2/service/sesv2"
	"github.com/aws/aws-sdk-go-v2/service/sesv2/types"
)

type IEmailService interface {
	SendEmail(from, to, subject, body string) error
}

type emailSender struct{}

func NewEmailSender() IEmailService {
	return &emailSender{}
}

func (es *emailSender) SendEmail(from, to, subject, body string) error {
	ctx := context.Background()

	cfg, err := config.LoadDefaultConfig(ctx, config.WithRegion("ap-northeast-1"))
	if err != nil {
		return err
	}

	client := sesv2.NewFromConfig(cfg)

	input := &sesv2.SendEmailInput{
		FromEmailAddress: &from,
		Destination: &types.Destination{
			ToAddresses: []string{to},
		},
		Content: &types.EmailContent{
			Simple: &types.Message{
				Body: &types.Body{
					Text: &types.Content{
						Data: &body,
					},
				},
				Subject: &types.Content{
					Data: &subject,
				},
			},
		},
	}

	_, err = client.SendEmail(ctx, input)
	if err != nil {
		return err
	}

	return nil
}
```

å†åº¦ã€SQSã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ã’ã¦ã€ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

ãªãŠã€ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡å…ƒã¨ã€é€ä¿¡å…ˆã¯ã€ã‚ã‚‰ã‹ã˜ã‚ç’°å¢ƒå¤‰æ•°ã§æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

```json
{
  "subject": "Test Email",
  "body": "Hello world from SQS"
}
```
ç„¡äº‹ã€æŒ‡å®šã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç‹¬è‡ªã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¦ã„ã¾ã—ãŸï¼ï¼

ã‚³ãƒ¼ãƒ‰ã®å…¨æ–‡ã¯ã€ä»¥ä¸‹ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚Šã¾ã™ã€‚

https://github.com/ogatakatsuya/mail-sender

# 6. Cloudflare Workersä¸Šã‹ã‚‰SQSã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹

ã¾ãšã€Cloudflare Workersç”¨ã®IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚ã¨ã‚Šã‚ãˆãšã€Send, Receiveã®ã¿ã®æ¨©é™ã‚’ä¸ãˆã¦ã¿ã¾ã—ãŸã€‚(ã—ã£ã‹ã‚Šã¨å‹•ä½œã—ã¾ã—ãŸğŸ™†)

æ¬¡ã«ã€SSRã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

å—ã‘å–ã£ãŸãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’çµ„ã¿ç«‹ã¦ã¦ã„ã¾ã™ã€‚ã“ã“ã¯Copilotã«ã—ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚

ãã—ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ->ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä½œæˆ->ã‚³ãƒãƒ³ãƒ‰ä½œæˆ->APIã‚’å©ãã¨ã„ã†ã„ã¤ã‚‚ã®æµã‚Œã§SQSã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ã„ã¾ã™ã€‚

```typescript
    const formattedMessage = `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”” New Contact Form Submission
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘¤ Sender Information:
   Name: ${validatedData.name}
   Email: ${validatedData.email}

ğŸ“§ Message Details:
   Subject: ${validatedData.subject}

ğŸ“ Message:
${validatedData.message}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Timestamp: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    `.trim();

    const sqsMessage = {
      subject: validatedData.subject,
      body: formattedMessage
    };

    const { env } = Astro.locals.runtime;

    const client = new SQSClient({
      region: "ap-northeast-1",
      credentials: {
        accessKeyId: env.SECRET_AWS_ACCESS_KEY,
        secretAccessKey: env.SECRET_AWS_SECRET_KEY,
      }
    });
    const params = {
      QueueUrl: env.SECRET_SQS_QUEUE_URL,
      MessageBody: JSON.stringify(sqsMessage),
    }
    const command = new SendMessageCommand(params);
    await client.send(command);
```

ã“ã‚Œã§ã€Cloudflare Workersä¸Šã‹ã‚‰ã€SQSã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¾”ï½¯ï¾€ï½°

# ã¾ã¨ã‚

ä»Šå›ã¯ã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’è‰²ã€…ã¨çµ„ã¿åˆã‚ã›ã¦ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

Resendã‚„SendGridãªã©ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã£ã¦ã„ã‚‹æ–¹ãŒå¤šã„ã¨æ€ã„ã¾ã™ãŒã€ç·´ç¿’ãŒã¦ã‚‰ã€ã‚‚ã£ã¨å¤§è¦æ¨¡ãªã‚µãƒ¼ãƒ“ã‚¹ã§ã‚‚é€šç”¨ã™ã‚‹ã‚ˆã†ãªã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªæ§‹æˆã«ã—ã¦ã¿ã¾ã—ãŸã€‚

ãŠãã‚‰ãã»ã¨ã‚“ã©ç„¡æ–™ã§é‹ç”¨ã§ãã‚‹ã¨æ€ã†ã®ã§ã€å½“åˆ†ã¯ã“ã®æ§‹æˆã§é‹ç”¨ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

ã‚ã¨ã¯Recaptchaã¨ã‹ã‚’å…¥ã‚Œã¦ã¿ã‚ˆã†ã‹ãªãã¨ã‹è€ƒãˆã¦ã„ã¾ã™ğŸ¤”

ä»¥ä¸Šã€‚