---
title: "OG画像を自動生成する仕組みをAWS Lambdaで構築する"
date: "2025-06-26"
tags:
  - AWS
  - Cloudflare
  - Astro
summary: "OG画像を自動生成する仕組みをLambdaで構築する"
theme: "default"
---

## OG画像を自動生成する仕組みをLambdaで構築する

ブログやWebページをシェアした際に表示されるOG画像（Open Graph画像）を、記事の更新に応じて自動生成したいと考えることはよくあります。今回は、AWS Lambdaを使ってOG画像を生成し、それをAstroとCloudflareで活用する方法を紹介します。

---

## 構成概要

以下のような構成でOG画像を生成・配信します：

- **Astro**: 静的サイトジェネレーター（OG画像のURLを埋め込む）
- **AWS Lambda**: OG画像の生成処理を実行（Node.js + `@vercel/og`など）
- **Cloudflare**: キャッシュ & CDNとして画像を高速配信

---

## LambdaでOG画像を生成する

Lambda関数は以下のような処理を担います：

1. クエリパラメータからタイトルなどの情報を取得
2. HTML/CSSで画像レイアウトを作成
3. Puppeteer や `@vercel/og` を使って画像として描画
4. `Content-Type: image/png` でレスポンスを返す

```typescript
import { createCanvas, loadImage } from 'canvas';
import { Handler } from 'aws-lambda';

export const handler: Handler = async (event) => {
  const title = event.queryStringParameters?.title || 'Default Title';
  
  // キャンバスのサイズを設定
  const width = 1200;
  const height = 630;
  const canvas = createCanvas(width, height);
  const ctx = canvas.getContext('2d');

  // 背景色を設定
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, width, height);

  // タイトルを描画
  ctx.fillStyle = '#000000';
  ctx.font = 'bold 48px Arial';
  ctx.fillText(title, 50, height / 2);

  // PNG画像として出力
  const buffer = canvas.toBuffer('image/png');
  
  return {
    statusCode: 200,
    headers: {
      'Content-Type': 'image/png',
    },
    body: buffer.toString('base64'),
    isBase64Encoded: true,
  };
};
```

## Astro側でOG画像URLを動的に設定

Astroのheadタグ内に以下のように記述しておくことで、各ページのタイトルを使ってOG画像を設定できます。

```Astro
<head>
  <meta property="og:title" content={post.data.title} />
  <meta property="og:image" content={`https://your-cloudflare-domain.com/og-image?title=${encodeURIComponent(post.data.title)}`} />
</head>
```